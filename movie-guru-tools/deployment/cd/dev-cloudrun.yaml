# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

steps:
  # Build and Push
  - name: "gcr.io/cloud-builders/docker"
    env:
      - 'DOCKER_BUILDKIT=1'
    args:
      [
        "build",
        "-t",
        "$_REGION-docker.pkg.dev/$PROJECT_ID/$_ARTIFACT_REGISTRY_REPO_NAME/$_CONTAINER_NAME:${_SHORT_SHA}",
        ".",
      ]
  - name: "gcr.io/cloud-builders/docker"
    args:
      [
        "push",
        "$_REGION-docker.pkg.dev/$PROJECT_ID/$_ARTIFACT_REGISTRY_REPO_NAME/$_CONTAINER_NAME:${_SHORT_SHA}",
      ]

  # Deploy to Staging
  - name: "gcr.io/cloud-builders/gcloud"
    id: deploy-staging
    entrypoint: gcloud
    args:
      - "run"
      - "deploy"
      - "${_CONTAINER_NAME}"
      - "--image"
      - "$_REGION-docker.pkg.dev/$PROJECT_ID/$_ARTIFACT_REGISTRY_REPO_NAME/$_CONTAINER_NAME:${_SHORT_SHA}"
      - "--region"
      - "${_REGION}"
      - "--project"
      - "${PROJECT_ID}"
      - "--allow-unauthenticated"
      - "--min-instances"
      - "0"
      - "--no-cpu-throttling"
      - "--cpu"
      - "1"
      - "--memory"
      - "1Gi"
      - "--concurrency"
      - "40"
      - "--service-account"
      - "movie-guru-chat-server-sa@${PROJECT_ID}.iam.gserviceaccount.com"
      - "--session-affinity"
      - "--set-env-vars"
      - "DB_HOST=${_DB_HOST},BUCKET_NAME=${_BUCKET_NAME},OTEL_SERVICE_NAME=movie-guru-mcp-server,GOOGLE_CLOUD_PROJECT=${PROJECT_ID},GOOGLE_CLOUD_LOCATION=${_REGION}"
      - "--network"
      - "movie-guru-network"
      - "--subnet"
      - "movie-guru-subnet"
      - "--session-affinity"
      - "--set-secrets" 
      - "DB_PASSWORD=postgres-root-password-secret:latest"
      - "--startup-probe"
      - 'initialDelaySeconds=30,tcpSocket.port=8080,timeoutSeconds=240,periodSeconds=240,failureThreshold=1'
      - "--cpu-boost"
      - "--session-affinity"

substitutions:
  _STAGING_PROJECT_ID: ${PROJECT_ID}
  _REGION: "us-central1"
  _ARTIFACT_REGISTRY_REPO_NAME: movie-guru
  _CONTAINER_NAME: movie-guru-mcp-server
  _DB_HOST: "10.2.0.2"
  _BUCKET_NAME: srinandans-next25-demo_posters

images:
  - $_REGION-docker.pkg.dev/$PROJECT_ID/$_ARTIFACT_REGISTRY_REPO_NAME/$_CONTAINER_NAME:${_SHORT_SHA}

options:
  pool:
    name: "projects/$PROJECT_ID/locations/$LOCATION/workerPools/movie-guru"
  logging: CLOUD_LOGGING_ONLY
  substitutionOption: ALLOW_LOOSE
  requestedVerifyOption: VERIFIED